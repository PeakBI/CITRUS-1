---
title: "Data Validation"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Data Validation}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r,include = FALSE}
devtools::install_github("peak-ai/citrus")
library(citrus)
library(dplyr)
```

```{r,include = FALSE}
formatted <- preprocess(citrus::transactional_data,
                        categories = c('country'), 
                        numeric_operation_list = c('min', 'sd'),
                        target = 'desc_chars', 
                        target_agg = 'mean')

hyperparameters = list(dependent_variable = 'response',
                       min_segmentation_fraction = 0.05,
                       number_of_personas = 6,
                       print_safety_check=20)

```

The `validate` function checks if the input data adheres to the expected format for modelling.
Both unsupervised and supervised methods require a customer level data frame with one row per customer.

This verification step is particularly important if the user skips the preprocessing step and passes their own preprocessed table. 

```{r, results = FALSE, message=FALSE, error=FALSE, fig.show= 'hide', warning=FALSE}
output <- segment(citrus::preprocessed_data, 
                  modeltype = 'tree',
                  steps = c('model'),
                  prettify = TRUE,
                  print_plot = TRUE)
```
#### Data Validation Example 1

The DF must have a column called `customerid`.

```{r, error=TRUE}
invalid_df <- formatted %>% 
  select(-customerid)

validate(invalid_df, supervised = TRUE, hyperparameters = hyperparameters)
```

#### Data Validation Example 2

The DF must have one observation per customer.

```{r, error=TRUE}
invalid_df <- formatted %>% 
  rbind(formatted[rep(1, 5), ])

validate(invalid_df, supervised = TRUE, hyperparameters = hyperparameters)
```

#### Data Validation Example 3

If the supervised model is selected a response column is required. 
The name of the response column can be arbitrary but needs to be specified in the `dependent_variable` hyperparameter. If not specified the validate function searches for a column called `response`.

```{r, error=TRUE}
invalid_df <- formatted %>% 
  select(-response)
validate(invalid_df, supervised = TRUE, hyperparameters = hyperparameters)
```

#### Data Validation Example 3

If `customerid`, and `response` column exist but there are no feature columns to predict over, an error is raised.

```{r,error=TRUE}
invalid_df <- formatted %>% 
  select(customerid, response)

validate(invalid_df, supervised = TRUE, hyperparameters = hyperparameters)
```
