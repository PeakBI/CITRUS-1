---
title: "Visualisations"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Visualisations}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup, include=FALSE}
devtools::install_github("peak-ai/citrus")
library(citrus)
library(dplyr)
library(rpart.plot)
```

CITRUS offers different visualization options, depending on model selected. 


### Decision Tree

If the tree model is used the rpart object can be easily visualised.

```{r}
hyperparameters <- list(dependent_variable = 'response',
                        min_segmentation_fraction = 0.05,
                        number_of_personas = 6,
                        print_plot = FALSE,
                        print_safety_check=20)
model <- tree_segment(citrus::preprocessed_data, hyperparameters)

rpart.plot(model$persona_model, roundint=FALSE)

```

However, the standard plotting functionality has some limitations with certain data so there is a prettify functionality added that provides nicer visualisations.

```{r}
model <- tree_segment_prettify(model,print_plot = T)
```

When using the `segment` function it is possible to choose to visualise and/or prettify the plot.

```{r}
model <- segment(citrus::preprocessed_data,
                    modeltype = 'tree',
                    FUN = NULL,
                    FUN_preprocess = NULL,
                    steps = c('model'),
                    prettify = T,
                    print_plot = T,
                    hyperparameters = hyperparameters, verbose = TRUE)

```

### Pair Plot

The pair plot is useful for visualizing the segments generated by the model, their distribution in the features' space and their correlation.

At the moment if unsupervised model is used, it is possible to pass the model straight to the `citrus_pair_plot` function.

```{r, message=FALSE}
hyperparameters <- list(centers = 'auto',
                                       iter_max = 50,
                                       nstart = 5,
                                       max_centers = 5, 
                                       segmentation_variables = NULL,
                                       standardize = TRUE)

preprocessed <- citrus::preprocessed_data %>% select(customerid, recency, frequency, monetary)

unuspervised_model <- unsupervised_segment(preprocessed, hyperparameters = hyperparameters, verbose = FALSE)

citrus_pair_plot(unuspervised_model)
```

In order to visualise the segments generated by the tree model, the model first needs to be processed in the `model management` layer. This step is automatically done when using the segment function. 

```{r}

hyperparameters <- list(dependent_variable = 'response',
                        min_segmentation_fraction = 0.05,
                        number_of_personas = 6,
                        print_plot = FALSE,
                        print_safety_check=20)

model <- segment(citrus::preprocessed_data,
                    modeltype = 'tree',
                    FUN = NULL,
                    FUN_preprocess = NULL,
                    steps = c('model'),
                    prettify = F,
                    print_plot = F,
                    hyperparameters = hyperparameters, verbose = TRUE)

citrus_pair_plot(model$CitrusModel, c("recency", "frequency", "monetary"))

```